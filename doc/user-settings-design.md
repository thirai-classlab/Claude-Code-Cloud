# 個人設定画面 設計書

| 項目 | 内容 |
|------|------|
| ドキュメント名 | 個人設定画面 設計書 |
| バージョン | 1.0 |
| 作成日 | 2026-01-01 |
| ステータス | Draft |

---

## 1. 概要

### 1.1 目的

ユーザーが個人設定（アカウント情報、外部サービス連携、テンプレート管理など）を一元管理できる画面を提供する。

### 1.2 アクセス方法

サイドバー最下部の設定ボタンから遷移。

```
┌──────────────────────┐
│  Sidebar             │
├──────────────────────┤
│                      │
│  📁 Projects         │
│  ├── Project A       │
│  ├── Project B       │
│  └── Project C       │
│                      │
│                      │
│                      │
│                      │
│                      │
├──────────────────────┤
│  👤 田中太郎         │
│  ⚙️ 設定             │  ← クリックで個人設定へ
└──────────────────────┘
```

---

## 2. 画面構成

### 2.1 全体レイアウト

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ← 戻る                              個人設定                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐  ┌───────────────────────────────────────────────┐│
│  │                 │  │                                               ││
│  │  アカウント     │  │  [選択されたセクションの内容]                 ││
│  │                 │  │                                               ││
│  │  インテグレー   │  │                                               ││
│  │  ション         │  │                                               ││
│  │                 │  │                                               ││
│  │  テンプレート   │  │                                               ││
│  │                 │  │                                               ││
│  │  セキュリティ   │  │                                               ││
│  │                 │  │                                               ││
│  │  外観           │  │                                               ││
│  │                 │  │                                               ││
│  └─────────────────┘  └───────────────────────────────────────────────┘│
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 URL構造

| URL | セクション |
|-----|-----------|
| `/settings` | 個人設定トップ（アカウントにリダイレクト） |
| `/settings/account` | アカウント設定 |
| `/settings/integrations` | インテグレーション |
| `/settings/integrations/github` | GitHub連携詳細 |
| `/settings/templates` | テンプレート管理 |
| `/settings/security` | セキュリティ |
| `/settings/appearance` | 外観設定 |

---

## 3. セクション詳細

### 3.1 アカウント設定

```
┌─────────────────────────────────────────────────────────────────────────┐
│  アカウント設定                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  プロフィール                                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌──────┐  表示名                                                       │
│  │      │  ┌─────────────────────────────────────────────┐              │
│  │ 👤   │  │ 田中太郎                                    │              │
│  │      │  └─────────────────────────────────────────────┘              │
│  └──────┘                                                               │
│  [アバター変更]                                                         │
│                                                                         │
│  メールアドレス                                                         │
│  ┌─────────────────────────────────────────────┐                        │
│  │ tanaka@example.com                          │  [変更]               │
│  └─────────────────────────────────────────────┘                        │
│                                                                         │
│                                                                         │
│  パスワード変更                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  現在のパスワード                                                       │
│  ┌─────────────────────────────────────────────┐                        │
│  │ ••••••••••••                                │                        │
│  └─────────────────────────────────────────────┘                        │
│                                                                         │
│  新しいパスワード                                                       │
│  ┌─────────────────────────────────────────────┐                        │
│  │                                             │                        │
│  └─────────────────────────────────────────────┘                        │
│  ※ 8文字以上、英数字と記号を含む                                       │
│                                                                         │
│  新しいパスワード（確認）                                               │
│  ┌─────────────────────────────────────────────┐                        │
│  │                                             │                        │
│  └─────────────────────────────────────────────┘                        │
│                                                                         │
│  [パスワードを変更]                                                     │
│                                                                         │
│                                                                         │
│  アカウント削除                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ⚠️ この操作は取り消せません。すべてのプロジェクトとデータが削除されます。│
│                                                                         │
│  [アカウントを削除]                                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.2 インテグレーション

```
┌─────────────────────────────────────────────────────────────────────────┐
│  インテグレーション                                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  外部サービスとの連携を管理します。                                     │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                                                                     ││
│  │  🐙 GitHub                                              [設定 →]   ││
│  │     2アカウント連携中                                              ││
│  │                                                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                                                                     ││
│  │  🦊 GitLab                                              [設定 →]   ││
│  │     未連携                                                          ││
│  │                                                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                                                                     ││
│  │  🪣 Bitbucket                                           [設定 →]   ││
│  │     未連携                                                          ││
│  │                                                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.3 GitHub連携詳細

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ← インテグレーション                     GitHub連携                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  連携済みアカウント                                         [+ 追加]   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                                                                     ││
│  │  👤 tanaka-work                                                     ││
│  │     ラベル: 仕事用                                                  ││
│  │     Token: ghp_xxxx...xxxx                                          ││
│  │     Scope: repo, read:user                                          ││
│  │     追加日: 2026-01-01                                              ││
│  │     使用中: Project A, Project B                                    ││
│  │                                                                     ││
│  │     [接続テスト]  [編集]  [削除]                                    ││
│  │                                                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                                                                     ││
│  │  👤 tanaka-personal                                                 ││
│  │     ラベル: 個人用                                                  ││
│  │     Token: ghp_yyyy...yyyy                                          ││
│  │     Scope: repo, read:user                                          ││
│  │     追加日: 2026-01-01                                              ││
│  │     使用中: Project C                                               ││
│  │                                                                     ││
│  │     [接続テスト]  [編集]  [削除]                                    ││
│  │                                                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│                                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  💡 ヒント                                                              │
│                                                                         │
│  Personal Access Tokenの作成方法:                                       │
│  1. GitHub Settings → Developer settings → Personal access tokens       │
│  2. 「Generate new token (classic)」をクリック                          │
│  3. 以下のスコープを選択:                                               │
│     - repo (リポジトリへのフルアクセス)                                 │
│     - read:user (ユーザー情報の読み取り)                                │
│  4. トークンを生成してコピー                                            │
│                                                                         │
│  [GitHubでトークンを作成 ↗]                                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### PAT追加モーダル

```
┌─────────────────────────────────────────────────────────────────────────┐
│  GitHubアカウントを追加                                            ✕   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ラベル（識別用）                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ 例: 仕事用、個人用、○○プロジェクト用                              ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  Personal Access Token                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx                       ││
│  └─────────────────────────────────────────────────────────────────────┘│
│  ※ トークンは暗号化して保存されます                                    │
│                                                                         │
│                                                                         │
│  [キャンセル]                                              [追加]       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.4 テンプレート管理

```
┌─────────────────────────────────────────────────────────────────────────┐
│  テンプレート管理                                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  作成したテンプレート                                                   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                                                                     ││
│  │  📄 Next.js + Tailwind テンプレート                                 ││
│  │     説明: Next.js 14 + TailwindCSS + TypeScript のスターター       ││
│  │     作成日: 2026-01-01                                              ││
│  │     公開: 🌐 パブリック                                             ││
│  │     使用回数: 5回                                                   ││
│  │                                                                     ││
│  │     [編集]  [複製]  [削除]                                          ││
│  │                                                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                                                                     ││
│  │  📄 FastAPI バックエンド                                            ││
│  │     説明: FastAPI + SQLAlchemy + Pydantic の API テンプレート      ││
│  │     作成日: 2025-12-15                                              ││
│  │     公開: 🔒 プライベート                                           ││
│  │     使用回数: 2回                                                   ││
│  │                                                                     ││
│  │     [編集]  [複製]  [削除]                                          ││
│  │                                                                     ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│                                                                         │
│  パブリックテンプレート                                     [すべて見る]│
│                                                                         │
│  ┌──────────────────────┐  ┌──────────────────────┐                     │
│  │ 📄 React SPA         │  │ 📄 Django REST      │                     │
│  │    by @user1         │  │    by @user2        │                     │
│  │    ⭐ 42             │  │    ⭐ 38            │                     │
│  └──────────────────────┘  └──────────────────────┘                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.5 セキュリティ

```
┌─────────────────────────────────────────────────────────────────────────┐
│  セキュリティ                                                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  セッション管理                                                         │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  現在のセッション                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │  🖥️ Chrome on macOS                                    現在の端末  ││
│  │     IP: 192.168.1.xxx                                              ││
│  │     最終アクセス: 今すぐ                                            ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  他のセッション                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │  📱 Safari on iPhone                                      [終了]   ││
│  │     IP: 192.168.1.yyy                                              ││
│  │     最終アクセス: 2時間前                                           ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  [すべてのセッションを終了]                                             │
│                                                                         │
│                                                                         │
│  2要素認証                                                              │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ⚠️ 2要素認証は無効です                                                │
│                                                                         │
│  [2要素認証を有効にする]                                                │
│                                                                         │
│                                                                         │
│  ログイン履歴                                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  2026-01-01 10:30  Chrome on macOS      192.168.1.xxx  ✅ 成功        │
│  2026-01-01 09:15  Safari on iPhone     192.168.1.yyy  ✅ 成功        │
│  2025-12-31 23:45  Firefox on Windows   203.xxx.xxx.xxx ❌ 失敗       │
│                                                                         │
│  [すべて表示]                                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### 3.6 外観設定

```
┌─────────────────────────────────────────────────────────────────────────┐
│  外観設定                                                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  テーマ                                                                 │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐               │
│  │               │  │               │  │               │               │
│  │   ⬛ Dark     │  │   ⬜ Light    │  │   🌓 System   │               │
│  │   (現在)      │  │               │  │               │               │
│  │               │  │               │  │               │               │
│  └───────────────┘  └───────────────┘  └───────────────┘               │
│                                                                         │
│                                                                         │
│  言語                                                                   │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ 日本語                                                          ▼  ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│                                                                         │
│  エディタ設定                                                           │
│  ─────────────────────────────────────────────────────────────────────  │
│                                                                         │
│  フォントサイズ                                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ 14px                                                            ▼  ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  フォントファミリー                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │ JetBrains Mono                                                  ▼  ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                         │
│  ☑ 行番号を表示                                                        │
│  ☑ ミニマップを表示                                                    │
│  ☐ 自動保存                                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. データモデル

### 4.1 GitHub PAT管理

```sql
-- ユーザーごとのGitHub PAT（複数登録可能）
CREATE TABLE user_github_tokens (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    label VARCHAR(100) NOT NULL,              -- 識別用ラベル（仕事用、個人用など）
    github_username VARCHAR(100) NOT NULL,    -- GitHubユーザー名
    encrypted_token TEXT NOT NULL,            -- 暗号化されたPAT
    scopes JSON,                              -- トークンのスコープ
    last_used_at DATETIME,                    -- 最後に使用した日時
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY (user_id, github_username)
);

-- プロジェクトとGitHubリポジトリの連携
CREATE TABLE project_github_links (
    id VARCHAR(36) PRIMARY KEY,
    project_id VARCHAR(36) NOT NULL,
    github_token_id VARCHAR(36) NOT NULL,     -- 使用するPAT
    repo_owner VARCHAR(100) NOT NULL,
    repo_name VARCHAR(100) NOT NULL,
    default_branch VARCHAR(100) DEFAULT 'main',
    current_branch VARCHAR(100),
    last_commit_sha VARCHAR(40),
    last_synced_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    FOREIGN KEY (github_token_id) REFERENCES user_github_tokens(id) ON DELETE CASCADE,
    UNIQUE KEY (project_id)
);
```

### 4.2 ER図

```
┌──────────────────┐       ┌──────────────────────┐
│     users        │       │  user_github_tokens  │
├──────────────────┤       ├──────────────────────┤
│ id (PK)          │──┐    │ id (PK)              │
│ email            │  │    │ user_id (FK)         │──┐
│ display_name     │  └───<│ label                │  │
│ hashed_password  │       │ github_username      │  │
└──────────────────┘       │ encrypted_token      │  │
                           │ scopes               │  │
                           └──────────────────────┘  │
                                       │             │
                                       ▼             │
┌──────────────────┐       ┌──────────────────────┐  │
│    projects      │       │ project_github_links │  │
├──────────────────┤       ├──────────────────────┤  │
│ id (PK)          │──────<│ id (PK)              │  │
│ name             │       │ project_id (FK)      │  │
│ user_id (FK)     │       │ github_token_id (FK) │<─┘
└──────────────────┘       │ repo_owner           │
                           │ repo_name            │
                           └──────────────────────┘
```

---

## 5. API設計

### 5.1 GitHub PAT管理API

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `GET /api/user/github-tokens` | GET | PAT一覧取得 |
| `POST /api/user/github-tokens` | POST | PAT追加 |
| `GET /api/user/github-tokens/{id}` | GET | PAT詳細 |
| `PUT /api/user/github-tokens/{id}` | PUT | PAT更新（ラベルのみ） |
| `DELETE /api/user/github-tokens/{id}` | DELETE | PAT削除 |
| `POST /api/user/github-tokens/{id}/test` | POST | 接続テスト |

### 5.2 アカウント管理API

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `GET /api/user/profile` | GET | プロフィール取得 |
| `PUT /api/user/profile` | PUT | プロフィール更新 |
| `PUT /api/user/password` | PUT | パスワード変更 |
| `DELETE /api/user/account` | DELETE | アカウント削除 |

### 5.3 セッション管理API

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| `GET /api/user/sessions` | GET | セッション一覧 |
| `DELETE /api/user/sessions/{id}` | DELETE | セッション終了 |
| `DELETE /api/user/sessions` | DELETE | 全セッション終了 |

---

## 6. フロントエンド設計

### 6.1 新規コンポーネント

| コンポーネント | パス | 説明 |
|---------------|------|------|
| `SettingsLayout` | `components/settings/` | 設定ページレイアウト |
| `SettingsSidebar` | `components/settings/` | 設定ナビゲーション |
| `AccountSettings` | `components/settings/` | アカウント設定 |
| `IntegrationSettings` | `components/settings/` | インテグレーション設定 |
| `GitHubIntegration` | `components/settings/` | GitHub連携管理 |
| `TemplateManager` | `components/settings/` | テンプレート管理 |
| `SecuritySettings` | `components/settings/` | セキュリティ設定 |
| `AppearanceSettings` | `components/settings/` | 外観設定 |
| `SettingsButton` | `components/layout/` | サイドバー設定ボタン |

### 6.2 Store設計

```typescript
// stores/userSettingsStore.ts
interface UserSettingsStore {
  // GitHub Tokens
  githubTokens: GitHubToken[];
  fetchGitHubTokens: () => Promise<void>;
  addGitHubToken: (label: string, token: string) => Promise<void>;
  updateGitHubToken: (id: string, label: string) => Promise<void>;
  deleteGitHubToken: (id: string) => Promise<void>;
  testGitHubToken: (id: string) => Promise<boolean>;

  // Profile
  profile: UserProfile | null;
  fetchProfile: () => Promise<void>;
  updateProfile: (data: UpdateProfileData) => Promise<void>;
  changePassword: (current: string, newPassword: string) => Promise<void>;

  // Sessions
  sessions: UserSession[];
  fetchSessions: () => Promise<void>;
  terminateSession: (id: string) => Promise<void>;
  terminateAllSessions: () => Promise<void>;

  // Appearance
  theme: 'dark' | 'light' | 'system';
  language: string;
  setTheme: (theme: 'dark' | 'light' | 'system') => void;
  setLanguage: (language: string) => void;
}
```

---

## 7. サイドバー設定ボタン

### 7.1 Sidebarコンポーネント更新

```
現在のSidebar:
┌──────────────────────┐
│  Projects            │
│  ├── Project A       │
│  └── Project B       │
│                      │
│                      │
│                      │
└──────────────────────┘

更新後:
┌──────────────────────┐
│  Projects            │
│  ├── Project A       │
│  └── Project B       │
│                      │
│                      │
├──────────────────────┤
│  👤 田中太郎         │
│  tanaka@example.com  │
│  ──────────────────  │
│  ⚙️ 設定        →   │
│  🚪 ログアウト       │
└──────────────────────┘
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 担当 |
|------|-----------|---------|------|
| 2026-01-01 | 1.0 | 初版作成 | Claude |
