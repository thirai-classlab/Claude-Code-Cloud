# コード生成に関する指示（Salesforce/LWC/Apex 向け）

## 採用技術
### 期待する役割 (エキスパートとしての振る舞い)

以下の技術スタックに精通したエキスパートとして振る舞ってください（本リポジトリ準拠）。

* 言語/ランタイム: Apex, JavaScript (LWC), SOQL/SOSL, XML メタデータ
* フレームワーク: Lightning Web Components, Aura（必要時）
* テスト: @salesforce/sfdx-lwc-jest（Jest）
* ツール: Salesforce CLI (SFDX), ESLint, Prettier, Husky, lint-staged

### エピック運用

* 大タスクは `epics/<epic-id>-<slug>/` をルートとして進行します。
* プロンプトは `.ai/prompts/` または `epics/<epic>/prompts/` に配置可能です。
* 逐次実行は `epics/<epic>/SETTINGS.md` の `plan` に従います。次に処理する ST は `status: ready` かつ依存を満たすものを優先。

# コロケーション

コンポーネントに関するフォルダ、ファイルの配置方法
コロケーションを採用します。

LWC でもコロケーションを採用します。コンポーネントとテスト（__tests__ または *.test.js）を同一フォルダに配置します。

## データ取得（LWC）
* @wire, imperative Apex 呼び出しを適材適所で使用。
* 参照・変更の責務を分離し、テストしやすいヘルパへ切出し。

## ロジック分離
* UI とロジック（ユーティリティ、データ整形）を分離し再利用性を高めます。

## 具体的な構成（例）

以下のディレクトリ構成を基本とします。

```
force-app/main/default/lwc/
  myComponent/
    myComponent.js
    myComponent.html
    myComponent.css
    myComponent.test.js
    helpers.js

```

# コード生成

* コードを書く前に既存のコードを深くレビューし動作を確認します。

* 正確な例を用いて、簡潔で技術的な JavaScript(LWC)/Apex コードを記述します。

* LWC のテンプレートは宣言的に記述します（`if:true`, `for:each` 等）。
* 関数型および宣言型のプログラミングパターンを使用し、クラスの使用は避けます。
* 補助動詞（`isLoading`、`hasError`など）を用いた説明的な変数名を使用します。
* ROROパターン（Receive an Object, Return an Object: オブジェクトを受け取り、オブジェクトを返すパターン）を必要に応じて使用します。
* エクスポートされたコンポーネント、サブコンポーネント、ヘルパー、静的コンテンツ、型でファイルを構成します。
* LWC コンポーネント名・フォルダはケバブケース（`my-component`）、ファイルは同ベース名（`myComponent.js`）。
* 純粋な関数には `function` キーワードを使用します。
* 単純なステートメントには簡潔な構文を使用します。
* 条件文では不要な中括弧を避け、1行文では中括弧を省略します。
* セミコロンは省略します（ただし、文の曖昧さを避けるために必要な場合は使用します）。


## コメント

* コード例を示す際は、各行の目的を詳細なコメントで説明し、実行結果も示します。
* 複雑なロジックには明確で簡潔なコメントを付けます。
* JSDoc 形式のコメントを使用して、関数やコンポーネントの説明を行います。
* コメントは日本語で記述します。
* コメントは、コードの意図や動作を明確にするために使用します。

## セキュリティ

* データを危険にさらしたり、新たな脆弱性をもたらさないように、あらゆる段階で確認します。


## Apex/LWC における注意
* Apex はバルク処理・ガバナ制限を考慮（SOQL ループ禁止、コレクション化）。
* セキュリティ（CRUD/FLS/Sharing）を明示的に考慮。
* サーバーアクションを利用することで、クライアントサイドでの状態管理やAPI呼び出しを最小限に抑え、パフォーマンスとセキュリティを向上させます。
* サーバーアクションを利用する際は、以下の点に注意してください：
  - 入力データのバリデーションにはZodを使用する。
  - エラー処理を適切に実装し、ユーザーに分かりやすいエラーメッセージを提供する。
  - サーバーアクションの戻り値として、成功時とエラー時の両方のケースをモデル化する。

## デプロイ/連携
* SFDX による source:push/pull、Apex テスト実行、Org 操作フローに準拠します。

## 備考
* Supabase/Next.js 等のWebアプリ指示は本プロジェクトでは任意です。必要時のみ個別タスクで参照してください。
* スキーマ定義の際は、以下の点に注意してください：
  - 各テーブルの型を明確に定義する。
  - 必要に応じて、リレーションや外部キーを適切に設定する。
  - 型安全性を確保するために、TypeScriptの型定義を活用する。
  - スキーマ変更時には、マイグレーションファイルを作成し、変更履歴を管理する。
