# 項目置換影響調査プロンプト

このプロンプトは、既存項目の運用を停止して別項目の運用を開始する「項目置換」において、既存の処理（Apex、Apex Trigger、Salesforce Flow、プロセスビルダー、ワークフロー、入力規則、数式項目等）に与える影響を網羅的に調査し、安全な移行計画を策定するためのテンプレートです。

---

## 0. 前提・制約
- 最重要: 項目置換による影響分析を漏れなく網羅的に実施すること
- 事前に Serena/（SerenaMCP）を有効化・初期化してください
- Salesforce MCP を用いて既存メタデータの取得を必須とします（オブジェクト定義、トリガ、フロー等）
- リポジトリ内の既存資料（`doc/`、`_task-list/task-list.md`）を尊重し、矛盾があれば提案のうえで解消します
- GitHub リンク基点: `https://github.com/classlab-inc/cl-crm-salesforce`、既定ブランチ: `main`

---

## 1. 入力（変数） — 必須/任意を明記

### 必須パラメータ
- **TARGET_OBJECT** (必須): 対象オブジェクトのAPI名（例: Account、ServiceGuide__c）
- **OLD_FIELD** (必須): 廃止予定の既存項目のAPI名（例: Old_Status__c）
- **NEW_FIELD** (必須): 新たに運用開始する項目のAPI名（例: New_Status__c）
- **NEW_FIELD_OBJECT** (任意): 新項目が別オブジェクトにある場合のオブジェクトAPI名（例: CxField__c）

### 任意パラメータ
- **REPLACEMENT_REASON** (任意): 項目置換の理由・背景（例: データ型変更、選択リスト値の再整理）
- **MIGRATION_STRATEGY** (任意): 移行戦略（例: 段階的移行、一括移行、並行運用期間の設定）
- **DATA_MAPPING** (任意): データ値のマッピング情報（JSON形式またはCSV形式で指定）
- **TARGET_PATH** (任意だが推奨): 出力ファイルの相対パス（例: `doc/analysis/account-status-field-replacement-impact.md`）
- **OVERWRITE** (任意, デフォルト=false): 既存ファイルがある場合に上書きするか
- **RUN_LOCAL_SCAN** (任意, デフォルト=true): リポジトリ内ソース走査を行う
- **RUN_MCP** (任意, デフォルト=true): Salesforce MCP で既存メタデータを取得するか
- **INCLUDE_CROSS_OBJECT_ANALYSIS** (任意, デフォルト=true): 関連オブジェクトの項目使用箇所分析を含めるか
- **INCLUDE_HISTORICAL_DATA** (任意, デフォルト=true): 履歴データ・監査証跡への影響を含めるか
- **EPIC_ID**（任意）: 紐づくエピック ID（例: E20250820-001）
- **CONTEXT**（任意）: 追加の要件・背景（URL や短い箇条書きで）

---

## 2. 目的
項目置換による既存システムへの影響を事前に分析し、以下を実現する：

1. **影響範囲の特定**: 廃止項目と新項目に関連する全処理を洗い出し
2. **オブジェクト間置換対応**: 同一オブジェクト内の項目置換だけでなく、参照先オブジェクトの項目への置換も考慮
3. **データ移行計画の策定**: 既存データを安全に新項目に移行する計画（オブジェクト間データ連携を含む）
4. **処理修正箇所の特定**: 修正が必要なApex、フロー、設定等を網羅的に洗い出し
5. **テストケースの策定**: 移行前後の動作を検証する包括的なテストケース
6. **リスク評価と軽減策**: 移行時のリスクとその対策を明確化

---

## 3. 調査対象範囲

### 3.1. Salesforceメタデータ
- **Apex クラス**: 項目参照、SOQL/SOSL、DML操作（オブジェクト間の関係項目アクセスを含む）
- **Apex トリガー**: Before/After トリガーでの項目参照・更新（関連オブジェクトの項目更新を含む）
  - `Trigger.oldMap` を使用した変更検知ロジックの特定
  - `ISCHANGED()` 相当の処理の特定
- **Salesforce フロー（Flow）**: 項目の取得・更新・条件分岐（オブジェクト間のデータ移動を含む）
  - 決定要素（decisions）のルール（rules）で `<doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>` 設定の調査
  - 「レコードが更新されたとき」のトリガー条件と対象項目の確認
  - `ISCHANGED()` 関数の使用箇所
  - `PRIORVALUE()` 関数の使用箇所
- **プロセスビルダー**: 条件・アクション・項目更新（関連レコード作成・更新を含む）
  - 「レコードが変更されたとき」の条件設定の確認
- **ワークフロールール**: 条件・項目更新・アラート（関連オブジェクトの項目参照を含む）
  - 評価条件の「作成時、および編集時に条件を満たす場合」設定の確認
- **入力規則（Validation Rules）**: 条件式での項目参照（関連オブジェクトの項目参照を含む）
  - `ISCHANGED()` 関数の使用箇所
  - `PRIORVALUE()` 関数の使用箇所
- **数式項目（Formula Fields）**: 計算式での項目参照（関連オブジェクトの項目参照を含む）
- **ロールアップ集計項目（Rollup Summary）**: 集計条件での項目参照
- **参照関係・主従関係**: オブジェクト間の関係定義と関連項目アクセス

### 3.2. UI関連
- **ページレイアウト**: 項目の配置・必須設定・読取専用設定
- **レコードタイプ**: 項目の可視性・必須性の制御
- **Lightning Web Components (LWC)**: JavaScript・HTMLでの項目参照
- **Visualforce**: ページ・コンポーネントでの項目参照
- **Aura コンポーネント**: 項目参照・バインディング
- **リストビュー**: 項目の表示・ソート・フィルタ

### 3.3. データアクセス・セキュリティ
- **項目レベルセキュリティ（FLS）**: 読取・編集権限設定
- **共有ルール**: 条件での項目参照
- **権限セット・プロファイル**: 項目アクセス権限
- **エスカレーションルール**: 条件での項目参照
- **割り当てルール**: 条件での項目参照

### 3.5. 統合・外部システム連携
- **API連携**: REST/SOAP APIでの項目参照
- **データローダー設定**: マッピングファイルでの項目指定
- **外部オブジェクト**: 外部IDマッピング

### 3.5. 履歴・監査
- **項目履歴管理**: 履歴追跡設定
- **監査証跡**: セットアップ監査証跡での項目参照
- **ごみ箱**: 削除レコードでの項目データ
- **データエクスポート**: バックアップでの項目データ

---

## 4. 出力仕様

### 4.1. ファイル構造
```
doc/analysis/
└── {target-object}-{old-field}-to-{new-field}-replacement-impact.md
    ├── 1. 実行概要
    ├── 2. 項目定義比較
    ├── 3. 影響箇所一覧
    ├── 4. データ移行計画
    ├── 5. 処理修正要件
    │   ├── 5.1. Apexクラス修正要件
    │   ├── 5.2. フロー修正要件
    │   ├── 5.3. 入力規則修正要件
    │   ├── 5.4. 数式項目修正要件
    │   ├── 5.5. 変更検知対応要件 ⭐必須⭐
    │   └── 5.X. その他修正要件
    ├── 6. テストケース
    ├── 7. リスク評価と軽減策
    ├── 8. 実行スケジュール
    └── 9. ロールバック計画
```

### 4.2. 詳細セクション

#### 4.2.1. 実行概要
- 置換対象項目の概要
- 置換理由・背景
- 影響範囲のサマリー
- 想定作業時間・リソース

#### 4.2.2. 項目定義比較
```markdown
| 項目 | 廃止項目 | 新項目 | 差分 |
|------|----------|---------|------|
| オブジェクト | 入居__c | CxField__c | オブジェクト変更 |
| API名 | Old_Status__c | New_Status__c | 項目名変更 |
| データ型 | テキスト(50) | 選択リスト | 型変更 |
| 必須 | 任意 | 必須 | 必須化 |
| デフォルト値 | - | "新規" | デフォルト値追加 |
| 選択リスト値 | - | 新規/処理中/完了 | 選択肢定義 |
| アクセス方法 | 直接参照 | 参照関係経由 | アクセス方法変更 |
```

#### 4.2.3. 影響箇所一覧
```markdown
### Apex クラス
| ファイル名 | 影響箇所 | 修正内容 | 影響度 | 備考 |
|------------|----------|----------|--------|------|
| AccountService.cls | line 45, 67 | 項目参照変更 | 高 | SOQL修正必要 |

### Apex トリガー
| ファイル名 | 影響箇所 | 修正内容 | 影響度 | 備考 |
|------------|----------|----------|--------|------|
| MoveInTrigger.trigger | line 23-35 | Trigger.oldMap変更検知ロジック修正 | 高 | 移行先オブジェクトでの変更検知実装必要 |

### フロー
| フロー名 | 要素 | 修正内容 | 影響度 | 備考 |
|----------|------|----------|--------|------|
| Account Update Flow | 条件分岐 | 条件式変更 | 高 | 選択リスト値対応 |
| CX Field Sync Flow | レコード作成 | オブジェクト間データ移動 | 高 | 新規フロー作成必要 |
| MoveIn Status Flow | 決定要素 | doesRequireRecordChangedToMeetCriteria設定 | 高 | 参照項目経由では変更検知不可 |

### 変更検知関連の特定項目
| 処理種別 | 対象 | 現在の実装 | 移行後の課題 | 対応策 |
|----------|------|------------|-------------|--------|
| フロー条件分岐 | MoveInFlow.decisions.FlagElectricityTurnedDown | doesRequireRecordChangedToMeetCriteria=true | 参照項目経由で変更検知不可 | 移行先オブジェクトでトリガー実装 |
| 入力規則 | Account.ValidationRule_Status | ISCHANGED(Status__c) | 参照項目でISCHANGED動作不可 | 代替実装検討必要 |
| Apexトリガー | MoveInTrigger | Trigger.oldMap比較 | 参照先変更を検知不可 | 代替実装検討必要 |

### 参照関係・関連オブジェクト
| 関連オブジェクト | 影響内容 | 修正内容 | 影響度 | 備考 |
|----------------|----------|----------|--------|------|
| 入居__c → CxField__c | 新規参照関係 | 参照項目作成 | 高 | データ連携設計必要 |
| 既存参照項目 | アクセス方法変更 | SOQL修正 | 中 | 関係経由アクセス |
```

#### 4.2.4. データ移行計画
```markdown
### 移行戦略
1. **事前準備フェーズ**
   - バックアップ取得
   - 新項目・新オブジェクト作成・設定
   - 参照関係の設計・作成
   - データマッピング検証

2. **移行実行フェーズ**
   - オブジェクト間参照関係の設定
   - データ変換・移動スクリプト実行
   - 処理修正デプロイ（SOQL、DML修正含む）
   - **変更検知ロジックの実装**（移行先オブジェクトでのトリガー・フロー作成）
   - 動作検証

3. **事後処理フェーズ**
   - 廃止項目の非表示化
   - 旧データアクセス処理の無効化
   - ユーザー通知・トレーニング
   - 廃止項目削除（猶予期間後）

### データマッピング
| 廃止項目値 | 新項目値 | 変換ルール | オブジェクト間連携 |
|------------|----------|------------|-------------------|
| "Active" | "新規" | 直接マッピング | 入居__c → CxField__c |
| "Inactive" | "完了" | 直接マッピング | 入居__c → CxField__c |
| NULL/空文字 | "新規" | デフォルト値設定 | 新規CxField__cレコード作成 |

### オブジェクト間データ移行
1. **CxField__cレコード作成**: 入居__cレコードに対応するCxField__cレコードを作成
2. **参照関係設定**: 入居__c.CxField__c項目にCxField__cレコードのIDを設定
3. **データ移行**: 入居__c.Old_Status__c → CxField__c.New_Status__c
4. **変更検知ロジック実装**: 
   - 移行先オブジェクトでのトリガー・フロー作成
   - 変更検知の代替手段実装
5. **整合性チェック**: データ移行後の整合性確認

### 変更検知対応策
#### A. 移行先オブジェクトでの追加フロー作成
- CxField__c の「レコードが更新されたとき」フローを作成
- 関連する入居__c レコードの処理を実行

#### B. 移行先オブジェクトでのトリガー実装
- CxField__c オブジェクトにトリガーを作成
- 変更時に関連レコードを更新する処理を実装
```

#### 4.2.5. 処理修正要件
**重要**: 3章「影響箇所一覧」で特定された全ての項目について、必ず修正要件を記載すること

各影響箇所について、具体的な修正内容を記載：
- **完全性チェック**: 3章の各セクション（3.1 Apex、3.2 フロー、3.3 入力規則、3.4 数式項目等）で特定された全項目が5章で網羅されていることを確認
- 修正前コード例
- 修正後コード例  
- 注意事項・考慮点

**出力形式**：
```markdown
### 5.1. Apexクラス修正要件
（3.1で特定された全てのApexクラスについて記載）

### 5.2. フロー修正要件
（3.2で特定された全てのフローについて記載）
**重要**: オブジェクト間移行の場合は、変更検知に関する影響と対応策を必ず記載
- doesRequireRecordChangedToMeetCriteria設定の影響
- 参照項目経由での変更検知不可問題
- 代替実装（移行先オブジェクトでのトリガー・フロー作成）の必要性

### 5.3. 入力規則修正要件
（3.3で特定された全ての入力規則について記載）
**重要**: ISCHANGED(), PRIORVALUE()関数使用箇所では、オブジェクト間移行での動作変化を明記
- 参照項目での関数動作制限
- 代替実装の必要性

### 5.4. 数式項目修正要件
（3.4で特定された全ての数式項目について記載）

### 5.5. 変更検知対応要件 ⭐新設必須セクション⭐
**オブジェクト間移行で変更検知が必要な処理について、具体的な対応策を記載**
- 影響を受ける変更検知処理の一覧
- 各処理の代替実装方法
- 移行先オブジェクトでの追加実装要件
- テスト方法

### 5.X. [その他カテゴリ]修正要件
（3章で特定されたその他全てのカテゴリについて記載）
```

#### 4.2.6. テストケース
```markdown
### 単体テスト
- [ ] 新項目への値設定テスト
- [ ] 必須チェックテスト
- [ ] 選択リスト値検証テスト

### 統合テスト
- [ ] Apex処理での新項目参照テスト（関係経由アクセス）
- [ ] フロー実行での新項目更新テスト
- [ ] オブジェクト間データ連携テスト
- [ ] 参照関係経由でのSOQLテスト

### 回帰テスト
- [ ] 既存機能の動作確認
- [ ] パフォーマンス影響確認
```

#### 4.2.7. リスク評価と軽減策
```markdown
| リスク | 影響度 | 発生確率 | 軽減策 | 担当 |
|--------|--------|----------|--------|------|
| データ消失 | 高 | 低 | バックアップ取得 | 管理者 |
| 処理エラー | 中 | 中 | 段階的デプロイ | 開発者 |
| ユーザー混乱 | 低 | 高 | 事前通知・トレーニング | 管理者 |
```

---

## 5. 実行手順

1. **初期化**
   - Serena メモリ読み込み（既存決定事項の把握）
   - 関連オブジェクト定義の確認（`doc/objects/` 参照）

2. **メタデータ取得**
   - Salesforce MCP による現在の設定取得
   - リポジトリ内ソースコードの走査

3. **影響分析**
   - 廃止項目の使用箇所特定
   - **変更検知機能の使用箇所特定**
     - フローの `<doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>` 設定
     - 入力規則の `ISCHANGED()`, `PRIORVALUE()` 関数使用
     - Apexトリガーの `Trigger.oldMap` 変更検知ロジック
     - プロセスビルダーの「レコードが変更されたとき」条件
   - 新項目との差分分析
   - 修正要件の洗い出し
   - **オブジェクト間移行における変更検知の代替手段検討**

4. **移行計画策定**
   - データ移行方法の決定
   - 実行スケジュールの作成
   - リスク評価と対策

5. **文書化**
   - 分析結果の整理
   - **完全性チェック実施**: 3章で特定した全影響箇所が5章で網羅されているかの確認
   - 実行可能な計画書の作成
   - 関係者レビュー用資料の準備

6. **品質検証**
   - **クロスチェック**: 3章の各セクション項目数と5章の対応セクション項目数の一致確認
   - **漏れチェック**: 3章で「影響度: 高」「影響度: 中」とした項目が5章で必ず修正要件として記載されているか確認

---

## 6. 出力契約（Acceptance Criteria）

### 必須出力項目
- [ ] 影響箇所一覧（100%網羅的）
- [ ] **変更検知機能の影響箇所一覧**（フロー、入力規則、トリガー別）
- [ ] **オブジェクト間移行における変更検知の代替実装計画**
- [ ] データ移行計画（実行可能レベル）
- [ ] 処理修正要件（具体的なコード例付き）
- [ ] **「5.5. 変更検知対応要件」セクション**（オブジェクト間移行時は必須）
- [ ] テストケース（実行可能レベル）
- [ ] リスク評価（定量的評価付き）

### 品質基準
- [ ] 全ての影響箇所が特定されている
- [ ] **変更検知が必要な処理が100%特定されている**
- [ ] **オブジェクト間移行での変更検知代替手段が具体的に設計されている**
- [ ] **「5.5. 変更検知対応要件」セクションが存在し、具体的な対応策が記載されている**
- [ ] **完全性チェック済み**: 3章「影響箇所一覧」で特定された全項目が5章「処理修正要件」で網羅されている
- [ ] **カテゴリ別網羅性**: 3章の各セクション（Apex、フロー、入力規則、数式項目等）に対応する5章のセクションが全て存在する
- [ ] 実行手順が具体的で再現可能
- [ ] リスクと軽減策が明確
- [ ] 既存資料との整合性が取れている
- [ ] YAML フロントマター付与済み

### ファイル出力
- メインファイル: `{TARGET_PATH}` または自動生成パス
- 必要に応じて補助ファイル作成（マッピングCSV等）
- `doc/README.md` への目次追加（OVERWRITE=true時）

---

## 7. 使用例

```bash
# 基本的な使用例（同一オブジェクト内）
TARGET_OBJECT="Account"
OLD_FIELD="Old_Status__c"
NEW_FIELD="Status__c"
REPLACEMENT_REASON="データ型をテキストから選択リストに変更"

# オブジェクト間置換の使用例
TARGET_OBJECT="MoveIn__c"
OLD_FIELD="Status__c"
NEW_FIELD="Status__c"
NEW_FIELD_OBJECT="CxField__c"
REPLACEMENT_REASON="CX項目オブジェクトへの統合"
DATA_MAPPING='{"新規":"新規","処理中":"処理中","完了":"完了"}'
MIGRATION_STRATEGY="段階的移行（参照関係作成→データ移行→処理修正）"
TARGET_PATH="doc/analysis/movein-to-cxfield-status-replacement.md"
OVERWRITE=false
```

---

## 8. 注意事項

### 実行前チェック
- [ ] 対象項目が実際に存在することを確認
- [ ] 新項目の設計が完了していることを確認
- [ ] 必要な権限（メタデータアクセス権限）があることを確認

### 実行時の注意
- すべての環境（本番・Sandbox）での影響を考慮
- カスタム開発コードだけでなく、標準機能の設定も含める
- ユーザーへの影響（UI変更、操作手順変更）も考慮
- データ量が多い場合のパフォーマンス影響も評価
- オブジェクト間置換の場合は、参照関係の設計とSOQLクエリへの影響を重点的に評価
- 関係経由でのアクセス制限（共有ルール、項目レベルセキュリティ）への影響確認
- **重要**: 変更検知が必要な処理の特定と代替実装の設計
  - フローの `<doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>` 設定箇所
  - 入力規則・数式項目での `ISCHANGED()`, `PRIORVALUE()` 使用箇所
  - Apexトリガーでの `Trigger.oldMap` 変更検知ロジック
  - 移行先オブジェクトでのトリガー・フローによる代替実装検討
- **必須**: 完全性チェックの実施
  - 3章の影響箇所一覧で特定された全項目が、5章の処理修正要件で漏れなく記載されているか確認
  - 特に「影響度: 高」「影響度: 中」の項目は必ず5章で修正要件を記述すること
  - セクション別チェック: 3.1→5.1、3.2→5.2、3.3→5.3、3.4→5.4 のように対応関係を明確化
- **必須**: 「5.5. 変更検知対応要件」セクションの作成
  - オブジェクト間移行時は必ず作成すること
  - 変更検知が必要な処理の具体的な対応策を明記
  - 単に「代替実装が必要」ではなく、具体的な実装方法を記載

### 継続的メンテナンス
- 新たな処理が追加された場合の影響確認
- 定期的な棚卸しによる不要項目の特定
- 項目統合の機会検討