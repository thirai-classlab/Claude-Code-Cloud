# 入力規則・Before Trigger 追加時の既存自動化処理影響調査プロンプト

このプロンプトは、入力規則やBefore Triggerでの入力チェックを追加する際に、既存の自動化処理（Apex、Apex Trigger、Salesforce フロー、プロセスビルダー、ワークフロー）に与える影響を網羅的に調査し、安全な実装計画を策定するためのテンプレートです。

---

## 0. 前提・制約
- 最重要: 既存の自動化処理への影響分析を漏れなく網羅的に実施すること
- 事前に Serena/（SerenaMCP）を有効化・初期化してください
- Salesforce MCP を用いて既存メタデータの取得を必須とします（オブジェクト定義、トリガ、フロー等）
- リポジトリ内の既存資料（`doc/`、`_task-list/task-list.md`）を尊重し、矛盾があれば提案のうえで解消します
- GitHub リンク基点: `https://github.com/classlab-inc/cl-crm-salesforce`、既定ブランチ: `main`

---

## 1. 入力（変数） — 必須/任意を明記

- TARGET_OBJECT (必須): 対象オブジェクトのAPI名（例: Account、ServiceGuide__c）
- VALIDATION_RULES (条件必須*): 追加予定の入力規則の概要（項目、条件、エラーメッセージ）
- BEFORE_TRIGGER_LOGIC (条件必須*): Before Triggerで追加予定の入力チェックロジック概要
- VALIDATION_FIELDS (自動抽出): 入力規則条件で使用される項目のAPI名リスト（手動指定も可）
- TARGET_PATH (任意だが推奨): 出力ファイルの相対パス（例: `doc/analysis/email-required-validation-impact-analysis.md`）
- OVERWRITE (任意, デフォルト=false): 既存ファイルがある場合に上書きするか
- RUN_LOCAL_SCAN (任意, デフォルト=true): リポジトリ内ソース走査を行う
- RUN_MCP (任意, デフォルト=true): Salesforce MCP で既存メタデータを取得するか
- INCLUDE_CROSS_OBJECT_ANALYSIS (任意, デフォルト=true): 関連オブジェクトの項目使用箇所分析を含めるか
- EPIC_ID（任意）: 紐づくエピック ID（例: E20250820-001）
- CONTEXT（任意）: 追加の要件・背景（URL や短い箇条書きで）

**条件必須の説明：**
- `VALIDATION_RULES` と `BEFORE_TRIGGER_LOGIC` のうち、少なくとも1つは必須
- 入力規則のみ追加する場合：`VALIDATION_RULES` を指定、`BEFORE_TRIGGER_LOGIC` は省略可
- Before Triggerのみ追加する場合：`BEFORE_TRIGGER_LOGIC` を指定、`VALIDATION_RULES` は省略可  
- 両方追加する場合：両方を指定

---

## 2. 目的
入力規則やBefore Triggerでの入力チェック追加による既存自動化処理への影響を事前に分析し、以下を実現する：

1. **影響範囲の特定**: 対象オブジェクトに関連する全自動化処理を洗い出し
2. **競合リスクの評価**: 新しい入力チェックと既存処理の競合可能性を評価
3. **項目使用箇所の網羅的分析**
   - 入力規則条件項目を参照・更新する全処理の洗い出し
   - オブジェクト横断での項目使用箇所特定
   - 親子関係・参照関係経由での間接的影響分析
   - 数式項目・ロールアップ集計項目経由での波及影響
4. **実行順序の検証**: トリガ実行順序、フロー実行タイミングの影響を分析
5. **テストケースの策定**: 既存処理を含めた包括的なテストケースを設計

---

## 3. 出力成果物（Acceptance Criteria）

エージェントは以下の構造で分析レポート（Markdown）を作成し、指定されたパス（または自動生成パス）に保存してください。

### 3.1 必須セクション構成

1. **メタ情報**
   - title: 影響分析レポート - [TARGET_OBJECT]
   - target_object: [TARGET_OBJECT]
   - analysis_date: [実行日]
   - epic_id: [EPIC_ID]（指定時）

2. **分析概要**
   - 対象オブジェクト概要
   - 追加予定の入力チェック概要（入力規則・Before Triggerロジック・または両方）
   - 分析スコープ・制約

3. **既存自動化処理の洗い出し**
   - **対象オブジェクト関連**
     - Apex Trigger（Before/After各タイミング）
     - Salesforce フロー（Record-Triggered Flow）
     - プロセスビルダー
     - ワークフロー
     - 入力規則（既存）
     - その他の自動化処理（Assignment Rule、Escalation Rule等）
   - **関連オブジェクト含む項目使用箇所**
     - 入力規則条件項目を更新する全てのApex Trigger（全オブジェクト対象）
     - 入力規則条件項目を更新する全てのフロー（全オブジェクト対象）
     - 親子関係・参照関係にあるオブジェクトの自動化処理
     - 数式項目・ロールアップ集計項目への影響

4. **実行順序・タイミング分析**
   ```
   Mermaid図による実行順序フローを必ず作成：
   - 現在の実行順序
   - 新しい入力チェック追加後の実行順序
   - 各処理間の依存関係・競合ポイント
   ```

5. **影響分析マトリックス**
   ```
   | 既存処理 | 処理内容 | 影響度 | 競合リスク | 対策 | テスト要否 |
   |---------|---------|--------|-----------|------|-----------|
   | AccountTrigger | 項目自動設定 | 高 | データ競合 | 実行順序調整 | 必須 |
   ```

6. **リスク評価・対策**
   - 高リスク項目の詳細分析
   - データ不整合リスク
   - パフォーマンス影響
   - ユーザー体験への影響
   - 推奨対策・回避方法

7. **テストケース設計**
   - 単体テスト（新規入力チェック単独）
   - 結合テスト（既存処理との組み合わせ）
   - エンドツーエンドテスト（ユーザー操作シナリオ）

### 3.2 品質チェックリスト

エージェントは以下を必ず確認・実施してください：

- [ ] 対象オブジェクトの全トリガを`doc/trigger/`、`force-app/main/default/triggers/`から洗い出し
- [ ] Record-Triggered Flowを`force-app/main/default/flows/`から洗い出し  
- [ ] プロセスビルダー・ワークフローの存在確認
- [ ] 既存入力規則の洗い出し・競合チェック
- [ ] **入力規則条件項目の使用箇所網羅的検索**
  - [ ] 全オブジェクトのApex Triggerでの項目参照・更新箇所特定
  - [ ] 全フローでの項目参照・更新箇所特定
  - [ ] プロセスビルダー・ワークフローでの項目使用箇所特定
  - [ ] 数式項目・ロールアップ集計での参照関係確認
  - [ ] 親子関係・参照関係経由での間接的影響確認
- [ ] 実行順序のMermaid図作成（詳細レベル）
- [ ] 各既存処理の影響度評価（高/中/低）
- [ ] テストケースの具体的手順・アサーション記載
- [ ] 段階的実装計画の策定

---

## 4. 実行手順

エージェントは以下の手順で分析を実行してください：

### Step 1: メタデータ収集・項目使用箇所分析
1. 対象オブジェクトの定義確認（`doc/objects/`、Salesforce MCP）
2. 入力規則条件項目の特定・抽出
3. **項目使用箇所の網羅的検索**
   - 全オブジェクトのApex Triggerでの項目使用箇所検索
   - 全フローでの項目参照・更新箇所検索
   - プロセスビルダー・ワークフローでの項目使用検索
   - 数式項目・ロールアップ集計での参照関係確認
4. 既存トリガの洗い出し（リポジトリ内検索）
5. フロー・プロセスの洗い出し（メタデータ検索）
6. 入力規則の洗い出し

### Step 2: 影響分析
1. 各自動化処理の詳細分析（実行タイミング、処理内容）
2. **項目更新パターンの分析**
   - 直接更新（同一オブジェクト内）
   - 間接更新（親子関係・参照関係経由）
   - 計算結果反映（数式項目・ロールアップ集計）
3. 新規入力チェックとの競合ポイント特定
4. 実行順序・依存関係の整理
5. パフォーマンス・ユーザビリティ影響評価

### Step 3: リスク評価
1. 影響度マトリックス作成
2. 高リスク項目の詳細分析
3. 対策・回避方法の検討

### Step 4: 計画策定
1. テストケースの設計

### Step 5: ドキュメント作成
1. 分析レポートの作成・保存
2. 関連ドキュメントの更新提案
3. チェックリストの完了確認

---

## 5. 出力ファイルパス規則

- デフォルトパス: `doc/analysis/[validation-rule-summary-kebab]-impact-analysis.md`
  - 例: `doc/analysis/email-required-validation-impact-analysis.md`
  - 例: `doc/analysis/status-transition-validation-impact-analysis.md`
- カスタムパス: TARGET_PATH 指定時はそのパスを使用
- 関連ファイル: 必要に応じて図表やCSVファイルを`doc/analysis/assets/`に保存

---

## 6. 注意事項

1. **網羅性の重視**: 見落としがちな自動化処理（Assignment Rule、Email Alert等）も含めて調査
2. **項目使用箇所の完全性**: 入力規則条件項目を使用する全ての処理（全オブジェクト対象）を漏れなく特定
3. **オブジェクト間関係の考慮**: 親子関係・参照関係・数式項目経由での間接的影響も含めて分析
4. **実行順序の理解**: Salesforceの標準実行順序を正確に把握し、カスタム処理の位置付けを明確化
5. **バルク処理への配慮**: 単一レコードだけでなく、バルク処理時の動作も考慮
6. **ユーザー権限**: プロファイル・権限セットによる動作差異も考慮
7. **テスト環境**: 本番環境と同等の設定でのテスト実施を前提とした計画策定

---

## 7. 成功基準

- 既存自動化処理の100%洗い出し完了
- **入力規則条件項目の使用箇所100%特定完了**（全オブジェクト対象）
- **オブジェクト間関係を含む影響分析完了**（親子・参照・数式項目経由）
- 影響度評価・対策の明確化
- 包括的なテストケース設計完了
- ステークホルダーが理解できる分かりやすいドキュメント作成